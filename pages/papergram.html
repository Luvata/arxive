<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paper Gram ‚Äì Arxive</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Space+Grotesk:wght@300;400;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- KaTeX -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
    />
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    ></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- Extended Styles -->
    <style>
      :root {
        --bg-color: #0c0e17;
        --card-bg: rgba(22, 24, 37, 0.9);
        --text-color: #e2e8f0;
        --accent-color: #64ffda;
        --secondary-text: #94a3b8;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Space Grotesk", monospace;
      }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        height: 100vh;
        overflow: hidden;
      }
      /* Toolbar Styles */
      .toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: var(--card-bg);
        border-bottom: 1px solid var(--accent-color);
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-around;
        padding: 0.5rem 1rem;
        z-index: 1100;
      }
      .toolbar > div {
        margin: 0.25rem;
      }
      .categories button,
      #prevDay,
      #nextDay,
      #exportLikes {
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s ease;
        font-size: 0.875rem;
      }
      .categories button.active,
      #exportLikes:hover,
      #prevDay:hover,
      #nextDay:hover {
        background: var(--accent-color);
        color: var(--bg-color);
      }
      #selectedDate {
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        color: var(--text-color);
        padding: 6px;
        border-radius: 6px;
        font-size: 0.875rem;
      }
      /* Responsive adjustments for toolbar */
      @media (max-width: 600px) {
        .toolbar {
          flex-direction: column;
          align-items: stretch;
          text-align: center;
        }
        .toolbar > div {
          margin: 0.5rem 0;
        }
        .categories {
          flex-wrap: wrap;
          justify-content: center;
        }
      }
      /* Hide scrollbar */
      ::-webkit-scrollbar {
        display: none;
      }
      /* Favorites panel button (top-right) */
      .favorites-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        z-index: 1100;
        font-size: 0.875rem;
        transition: background 0.2s ease;
      }
      .favorites-btn:hover {
        background: var(--accent-color);
        color: var(--bg-color);
      }
      /* Filter panel button (top-left) */
      .filter-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        z-index: 1100;
        font-size: 0.875rem;
        transition: background 0.2s ease;
      }
      .filter-btn:hover {
        background: var(--accent-color);
        color: var(--bg-color);
      }
      /* Favorites Panel */
      .favorites-panel {
        position: fixed;
        top: 60px;
        right: 20px;
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        border-radius: 12px;
        padding: 1rem;
        width: 300px;
        max-height: 70vh;
        overflow-y: auto;
        z-index: 1050;
        transform: translateX(120%);
        transition: transform 0.3s ease;
      }
      .favorites-panel.show {
        transform: translateX(0);
      }
      .favorite-item {
        padding: 0.75rem;
        border-radius: 6px;
        background: rgba(100, 255, 218, 0.05);
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .favorite-item:hover {
        background: rgba(100, 255, 218, 0.1);
      }
      /* Filter Panel (left side) */
      .filter-panel {
        position: fixed;
        top: 60px;
        left: 20px;
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        border-radius: 12px;
        padding: 1rem;
        width: 300px;
        max-height: 70vh;
        overflow-y: auto;
        z-index: 1050;
        transform: translateX(-120%);
        transition: transform 0.3s ease;
      }
      .filter-panel.show {
        transform: translateX(0);
      }
      .filter-item {
        display: block;
        width: 100%;
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s ease;
        text-align: left;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
      }
      .filter-item.active,
      .filter-item:hover {
        background: var(--accent-color);
        color: var(--bg-color);
      }
      .filter-config {
        margin-top: 1rem;
      }
      .filter-config input {
        width: calc(100% - 12px);
        padding: 4px 6px;
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        color: var(--text-color);
        border-radius: 4px;
        margin-bottom: 0.5rem;
      }
      .filter-config button {
        width: 100%;
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s ease;
        font-size: 0.875rem;
      }
      .filter-config button:hover {
        background: var(--accent-color);
        color: var(--bg-color);
      }
      /* Main Container for Paper Cards */
      .container {
        height: 100vh;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        padding: 80px 1rem 1rem;
      }
      /* Fixed Paper Progress Indicator */
      .fixed-progress {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card-bg);
        padding: 0.5rem 1rem;
        border: 1px solid var(--accent-color);
        border-radius: 6px;
        z-index: 1200;
        font-size: 0.875rem;
      }
      /* Paper Card Styles */
      .paper-card {
        margin: auto;
        content-visibility: auto;
        contain-intrinsic-size: 1000px;
        min-height: calc(100vh - 100px);
        scroll-snap-align: start;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        position: relative;
      }
      .paper-content {
        margin: auto;
        margin-top: 2rem;
        background: var(--card-bg);
        padding: 1.25rem;
        border-radius: 12px;
        border: 1px solid rgba(100, 255, 218, 0.1);
        width: calc(100% - 2rem);
        max-width: 800px;
        backdrop-filter: blur(10px);
        transition: opacity 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .paper-header {
        margin-bottom: 1rem;
        padding-right: 120px;
      }
      .title {
        font-size: 1rem;
        font-family: "Playfair Display", serif;
        color: var(--accent-color);
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }
      .announce-type {
        display: inline-block;
        background: var(--accent-color);
        color: var(--bg-color);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
      }
      .authors {
        font-size: 0.875rem;
        color: var(--secondary-text);
        margin-bottom: 1rem;
        font-family: "Space Mono", monospace;
      }
      .key-results {
        margin: 1rem 0;
        padding: 0.75rem;
        background: rgba(100, 255, 218, 0.05);
        border-radius: 8px;
        font-family: "Space Mono", monospace;
        border-left: 3px solid var(--accent-color);
      }
      .result-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
      }
      .result-icon {
        flex-shrink: 0;
      }
      .abstract {
        font-size: 0.875rem;
        line-height: 1.6;
        color: var(--text-color);
        margin-bottom: 1.5rem;
        word-wrap: break-word;
      }
      .metadata {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 1rem;
        border-top: 1px solid rgba(100, 255, 218, 0.1);
        font-size: 0.75rem;
        color: var(--secondary-text);
      }
      .like-button {
        color: var(--secondary-text);
        border: none;
        background: none;
        cursor: pointer;
        transition: color 0.2s ease;
        font-size: 1.25rem;
      }
      .like-button.liked {
        color: var(--accent-color);
      }
      .share-container {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        display: flex;
        gap: 0.5rem;
        z-index: 10;
      }
      /* Only one share button (copy-link) remains */
      .share-btn {
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        color: var(--accent-color);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
        backdrop-filter: blur(5px);
      }
      .share-btn:hover {
        background: var(--accent-color);
        color: var(--bg-color);
      }
      .read-more {
        color: var(--accent-color);
        text-decoration: none;
      }
      .read-more:hover {
        text-decoration: underline;
      }
      .footer {
        position: fixed;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75rem;
        color: var(--secondary-text);
        background: var(--card-bg);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(100, 255, 218, 0.1);
        z-index: 1100;
        white-space: nowrap;
      }
      .footer a {
        color: var(--accent-color);
        text-decoration: none;
        transition: color 0.2s ease;
      }
      .footer a:hover {
        text-decoration: underline;
        opacity: 0.8;
      }
      .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--accent-color);
        color: var(--bg-color);
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-size: 0.875rem;
        opacity: 0;
        transition: all 0.3s ease;
      }
      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="categories">
        <button class="category-btn" data-category="cs.AI">cs.AI</button>
        <button class="category-btn active" data-category="cs.CV">cs.CV</button>
        <button class="category-btn" data-category="cs.CL">cs.CL</button>
        <button class="category-btn" data-category="cs.LG">cs.LG</button>
      </div>
      <div class="date-selector">
        <button id="prevDay">Prev Day</button>
        <input type="date" id="selectedDate" />
        <button id="nextDay">Next Day</button>
      </div>
      <div class="export-likes">
        <button id="exportLikes">Export Likes</button>
      </div>
    </div>

    <!-- Favorites Panel Toggle (top-right) -->
    <button class="favorites-btn" id="favoritesToggle">Favorites</button>
    <div class="favorites-panel" id="favoritesPanel">
      <div id="favoritesList"></div>
    </div>

    <!-- Filter Panel Toggle (top-left) -->
    <button class="filter-btn" id="filterToggle">Filter</button>
    <div class="filter-panel" id="filterPanel">
      <div id="filterList"></div>
      <button class="filter-item" id="clearFilter">Clear Filter</button>
      <div class="filter-config">
        <input
          type="text"
          id="filterKeywordsInput"
          placeholder="Enter keywords, comma-separated"
        />
        <button id="saveFilterKeywords">Save Keywords</button>
      </div>
    </div>

    <!-- Main Container for Paper Cards -->
    <div class="container" id="container"></div>

    <!-- Fixed Paper Progress Indicator -->
    <div id="fixedProgress" class="fixed-progress">Paper 0 of 0</div>

    <!-- JavaScript -->
    <script>
      /* ====== Global State & Config ====== */
      // Default to cs.CV
      const baseURL = "https://raw.githubusercontent.com/Luvata/arxive/main/xml/"; // or your own XML path
      let selectedCategory = "cs.CV";
      let papers = [];
      let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

      // Filter config and state
      let filterKeywords = JSON.parse(localStorage.getItem("filterKeywords") ||
        '["diffusion", "gan", "llm", "flow", "adversarial attack"]'
      );
      let activeFilter = "";

      // Set selected date to today (YYYY-MM-DD)
      const today = new Date().toISOString().split("T")[0];
      let selectedDate = today;
      document.getElementById("selectedDate").value = selectedDate;
      document.getElementById("selectedDate").setAttribute("max", today);

      /* ====== Toolbar Event Listeners ====== */
      // Category button clicks
      document.querySelectorAll(".category-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".category-btn").forEach((b) =>
            b.classList.remove("active")
          );
          btn.classList.add("active");
          selectedCategory = btn.getAttribute("data-category");
          fetchPapersFromXML(selectedDate, selectedCategory);
        });
      });
      // Date change via input
      document
        .getElementById("selectedDate")
        .addEventListener("change", (e) => {
          selectedDate = e.target.value;
          fetchPapersFromXML(selectedDate, selectedCategory);
        });
      // Prev/Next day buttons
      document.getElementById("prevDay").addEventListener("click", () => {
        selectedDate = changeDate(selectedDate, -1);
        document.getElementById("selectedDate").value = selectedDate;
        fetchPapersFromXML(selectedDate, selectedCategory);
      });
      document.getElementById("nextDay").addEventListener("click", () => {
        const next = changeDate(selectedDate, 1);
        if (next <= today) {
          selectedDate = next;
          document.getElementById("selectedDate").value = selectedDate;
          fetchPapersFromXML(selectedDate, selectedCategory);
        }
      });
      // Favorites panel toggle
      document
        .getElementById("favoritesToggle")
        .addEventListener("click", () => {
          document.getElementById("favoritesPanel").classList.toggle("show");
        });
      // Filter panel toggle
      document.getElementById("filterToggle").addEventListener("click", () => {
        document.getElementById("filterPanel").classList.toggle("show");
      });
      // Export Likes button
      document.getElementById("exportLikes").addEventListener("click", exportLikes);
      // Filter configuration: Save keywords from input
      document.getElementById("saveFilterKeywords").addEventListener("click", () => {
        const input = document.getElementById("filterKeywordsInput").value;
        filterKeywords = input.split(",").map(s => s.trim()).filter(Boolean);
        localStorage.setItem("filterKeywords", JSON.stringify(filterKeywords));
        updateFilterPanel();
        renderPapers();
      });
      // Clear filter button
      document.getElementById("clearFilter").addEventListener("click", () => {
        activeFilter = "";
        updateFilterPanel();
        renderPapers();
      });

      /* ====== Utility Functions ====== */
      // Change date by n days; returns YYYY-MM-DD
      function changeDate(dateStr, n) {
        const date = new Date(dateStr);
        date.setDate(date.getDate() + n);
        return date.toISOString().split("T")[0];
      }
      // Show a toast message
      function showToast(message) {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add("show"), 100);
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }

      /* ====== Extract Key Results from Abstract ====== */
      function extractKeyResults(abstract) {
        const results = [];
        const sentences = abstract.split(/[.!?]+/);
        const keyPhrases = [
          "propose", "present", "introduce",
          "achieve", "show", "demonstrate",
          "improve", "outperform", "better",
          "novel", "new", "first"
        ];
        sentences.forEach(sentence => {
          if (results.length < 3 &&
              keyPhrases.some(phrase => sentence.toLowerCase().includes(phrase))) {
            results.push(sentence.trim());
          }
        });
        if (results.length === 0 && sentences.length > 0) {
          results.push(sentences[0].trim());
        }
        return results;
      }

      /* ====== Fetch & Parse XML ====== */
      async function fetchPapersFromXML(date, category) {
        const catMapping = {
          "cs.AI": "cs-ai",
          "cs.CV": "cs-cv",
          "cs.CL": "cs-cl",
          "cs.LG": "cs-lg",
        };
        const fileName = `${date}-${catMapping[category]}.xml`;
        const url = baseURL + fileName;
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Network error");
          const text = await response.text();
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(text, "application/xml");

          // Locate <item> elements
          let items = xmlDoc.querySelectorAll("channel > item");
          if (items.length === 0) {
            items = xmlDoc.querySelectorAll("item");
          }
          papers = [];

          items.forEach((item) => {
            // Title
            const titleEl = item.querySelector("title");
            const title = titleEl ? titleEl.textContent : "";

            // --- Updated Author Extraction ---
            let authors = "";
            const authorEls = item.querySelectorAll("author > name");
            if (authorEls.length > 0) {
              authors = Array.from(authorEls).map(a => a.textContent).join(", ");
            } else {
              const creators = item.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/", "creator");
              if (creators.length > 0) {
                authors = Array.from(creators).map(c => c.textContent).join(", ");
              }
            }

            // Description/Abstract (remove redundant prefix if exists)
            let description = "";
            const descEl = item.querySelector("description");
            if (descEl) {
              description = descEl.textContent;
              if (description.includes("Abstract:")) {
                description = description.substring(description.indexOf("Abstract:") + "Abstract:".length).trim();
              }
            }

            // Link
            const linkEl = item.querySelector("link");
            const link = linkEl ? linkEl.textContent : "";

            // Published Date
            let published = "";
            const pubEl = item.querySelector("pubDate");
            if (pubEl) {
              published = new Date(pubEl.textContent).toLocaleDateString();
            } else {
              published = date;
            }

            // arXiv ID extraction with updated regex:
            let arxivId = "";
            const match = link.match(/abs\/(.+?)(?:\/|\?|$)/);
            if (match) {
              arxivId = match[1];
            } else {
              arxivId = link;
            }

            // Extract announce type (if available)
            let announceType = "";
            const announceTypeEl = item.querySelector("arxiv\\:announce_type") || item.querySelector("announce_type");
            if (announceTypeEl) {
              announceType = announceTypeEl.textContent;
            }

            papers.push({
              title,
              authors,
              abstract: description,
              link,
              published,
              arxivId,
              announceType,
            });
          });

          renderPapers();
          updateFavoritesList();
          updateFilterPanel();
        } catch (error) {
          console.error("Error fetching papers:", error);
          document.getElementById("container").innerHTML =
            "<p>Error loading papers. Please try a different date or category.</p>";
        }
      }

      /* ====== Render Papers ====== */
      function renderPapers() {
        const container = document.getElementById("container");
        container.innerHTML = "";

        // Filter papers if an active filter is set
        const filteredPapers = activeFilter
          ? papers.filter(p =>
              p.title.toLowerCase().includes(activeFilter.toLowerCase()) ||
              p.abstract.toLowerCase().includes(activeFilter.toLowerCase())
            )
          : papers;

        if (filteredPapers.length === 0) {
          const msg = document.createElement("p");
          msg.textContent = "No papers found for this date/category/filter.";
          container.appendChild(msg);
          updateFixedProgress(0, 0);
          return;
        }

        // Render each paper
        filteredPapers.forEach((paper) => {
          const paperCard = document.createElement("div");
          paperCard.className = "paper-card";
          const isLiked = favorites.some((f) => f.arxivId === paper.arxivId);
          const keyResults = extractKeyResults(paper.abstract);

          paperCard.innerHTML = `
            <div class="paper-content">
              <!-- Share Icons: Only the Copy Link button -->
              <div class="share-container">
                <button class="share-btn copy-link" title="Copy Link">
                  <i class="fas fa-link"></i>
                </button>
              </div>

              <!-- Title, Announce Type & Authors -->
              <div class="paper-header">
                <h2 class="title">${paper.title}</h2>
                ${paper.announceType ? `<div class="announce-type">${paper.announceType}</div>` : ""}
                <div class="authors">${paper.authors}</div>
              </div>

              <!-- Key Results / Findings -->
              <div class="key-results">
                ${keyResults
                  .map(
                    (result) => `
                  <div class="result-item">
                    <span class="result-icon">üîç</span>
                    <span>${result}</span>
                  </div>
                `
                  )
                  .join("")}
              </div>

              <!-- Full Abstract -->
              <p class="abstract">${paper.abstract}</p>

              <!-- Bottom Metadata: Date, Like Button, Read More -->
              <div class="metadata">
                <span>${paper.published}</span>
                <button class="like-button ${isLiked ? "liked" : ""}">${
            isLiked ? "‚ù§Ô∏è" : "ü§ç"
          }</button>
                <a href="${paper.link}" target="_blank" class="read-more">Read More</a>
              </div>
            </div>
          `;

          // Only the copy-link share button remains
          paperCard
            .querySelector(".copy-link")
            .addEventListener("click", () =>
              sharePaper("copy", paper)
            );
          const likeButton = paperCard.querySelector(".like-button");
          likeButton.addEventListener("click", () =>
            toggleFavorite(paper, likeButton)
          );

          container.appendChild(paperCard);
        });

        // After rendering, set up the progress observer
        setupProgressObserver();
      }

      /* ====== Update Fixed Progress Indicator ====== */
      function updateFixedProgress(current, total) {
        document.getElementById("fixedProgress").innerText =
          total === 0 ? "No papers" : `Paper ${current} of ${total}`;
      }

      /* ====== Setup IntersectionObserver for Paper Progress ====== */
      function setupProgressObserver() {
        const container = document.getElementById("container");
        const paperCards = container.querySelectorAll(".paper-card");
        const total = paperCards.length;
        if (total === 0) {
          updateFixedProgress(0, 0);
          return;
        }
        const observerOptions = {
          root: container,
          threshold: 0.5,
        };
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const index = Array.from(paperCards).indexOf(entry.target) + 1;
              updateFixedProgress(index, total);
            }
          });
        }, observerOptions);
        paperCards.forEach(card => observer.observe(card));
      }

      /* ====== Update Filter Panel ====== */
      function updateFilterPanel() {
        const filterList = document.getElementById("filterList");
        filterList.innerHTML = "";
        filterKeywords.forEach(keyword => {
          // Count how many papers match this keyword in title/abstract
          const count = papers.filter(p =>
            p.title.toLowerCase().includes(keyword.toLowerCase()) ||
            p.abstract.toLowerCase().includes(keyword.toLowerCase())
          ).length;
          const btn = document.createElement("button");
          btn.className = "filter-item" + (activeFilter.toLowerCase() === keyword.toLowerCase() ? " active" : "");
          btn.textContent = `${keyword} (${count})`;
          btn.addEventListener("click", () => {
            activeFilter = keyword;
            updateFilterPanel();
            renderPapers();
          });
          filterList.appendChild(btn);
        });
      }

      /* ====== Like / Favorites Handling ====== */
      function toggleFavorite(paper, button) {
        const index = favorites.findIndex((f) => f.arxivId === paper.arxivId);
        if (index === -1) {
          paper.likedAt = new Date().toISOString();
          favorites.push(paper);
          button.classList.add("liked");
          button.textContent = "‚ù§Ô∏è";
        } else {
          favorites.splice(index, 1);
          button.classList.remove("liked");
          button.textContent = "ü§ç";
        }
        localStorage.setItem("favorites", JSON.stringify(favorites));
        updateFavoritesList();
      }

      function updateFavoritesList() {
        const list = document.getElementById("favoritesList");
        list.innerHTML = "";
        favorites.forEach((paper) => {
          const item = document.createElement("div");
          item.className = "favorite-item";
          item.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.25rem;">${paper.arxivId}</div>
            <div style="font-size: 0.8rem; color: var(--secondary-text);">
              Added: ${paper.published} <br/>
              Liked: ${new Date(paper.likedAt).toLocaleString()}
            </div>
          `;
          item.addEventListener("click", () => {
            window.open(paper.link, "_blank");
          });
          list.appendChild(item);
        });
      }

      /* ====== Share Paper (Copy Only) ====== */
      function sharePaper(platform, paper) {
        const title = paper.title;
        const url = paper.link;
        if (platform === "copy") {
          navigator.clipboard.writeText(`${title}\n${url}`);
          showToast("Link copied to clipboard!");
        }
      }

      /* ====== Export Likes ====== */
      function exportLikes() {
        const data = JSON.stringify(favorites, null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "favorites.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      /* ====== Initial Load ====== */
      fetchPapersFromXML(selectedDate, selectedCategory);
    </script>
  </body>
</html>
